#!/usr/bin/env python3
# This file is placed in the Public Domain.


"objects"


import inspect
import os
import queue
import shutil
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from tob.clients import Client
from tob.command import Config, command, parse, scan, scanner
from tob.handler import Event
from tob.logging import level
from tob.persist import Workdir, moddir, skel
from tob.runtime import check
from tob.threads import launch
from tob.utility import elapsed


import tobot.modules as MODS


CHECKSUM = "74c8e52fc1ef4d1f5dc90eae4f2200c4"

Workdir.wdr = ".test"


events = queue.Queue()


class CLI(Client):

    def __init__(self):
        Client.__init__(self)
        self.register("command", command)

    def raw(self, txt):
        if "v" in Config.opts:
            print(txt)


class Pool:

    clients = []
    lock = threading.RLock()
    nrcpu = 1
    nrlast = 0

    @staticmethod
    def add(clt):
        "add client to pool."
        Pool.clients.append(clt)

    @staticmethod
    def init(nr=None, verbose=False):
        "initialize client pool."
        Pool.nrcpu = nr or os.cpu_count()
        for _x in range(Pool.nrcpu):
            clt = CLI()
            clt.start()
            Pool.add(clt)

    @staticmethod
    def put(evt):
        "dispatch to client."
        with Pool.lock:
            if Pool.nrlast >= Pool.nrcpu-1:
                Pool.nrlast = 0
            clt = Pool.clients[Pool.nrlast]
            clt.put(evt)
            Pool.nrlast += 1


def banner(name, version):
    tme = time.ctime(time.time()).replace("  ", " ")
    logger = logging.getLogger()
    print("%s %s since %s (%s)" % (
                                   name.upper(),
                                   version,
                                   tme,
                                   logging.getLevelName(logger.getEffectiveLevel())
                                  ))
    sys.stdout.flush()


def consume():
    while True:
        try:
            event = events.get()
            event.wait()
            events.task_done()
        except (KeyboardInterrupt, EOFError):
            os._exit(0)


def payload(todo):
    for cmd, example in todo.items():
        for ex in example:
            evt = Event()
            evt.txt = f"{cmd} {ex}"
            evt.type = "command"
            Pool.put(evt)
            events.put(evt)


def main():
    if os.path.exists(Workdir.wdr):
        shutil.rmtree(Workdir.wdr)
    clt = CLI()
    parse(Config, " ".join(sys.argv[1:]))
    if "v" in Config.opts:
        banner(Config.name, Config.version)
    scanner(MODS)
    args = sys.argv[1:]
    if "z" in Config.opts:
        Pool.init(6)
    else:
        Pool.init(1)
    starttime = time.time()
    thrs = []
    NRS = Config.index or 1
    for _x in range(NRS):
        payload(pre)
    for _x in range(NRS):
        thrs.append(launch(payload, examples))
    for _x in range(NRS):
        payload(post)
    for thr in thrs:
        thr.join()
    launch(consume)
    nrevents = events.qsize()
    events.join()
    endtime = time.time()
    lap = elapsed(endtime-starttime)
    percall = (endtime-starttime)/nrevents
    nrs = events.qsize()
    if "v" in Config.opts:
        print(f"{nrs} events left.")
        print(f"total: {lap} nrs: {nrevents} call: %.6fs" % percall)
    sys.exit()


examples = {
    "cmd": [""],
    "dis": [""],
    "dne": ["", "test2"],
    "dpl": ["hnrss title,url", ""],
    "flt": [""],
    "fnd": ["", "log", "rss", "config", "todo"],
    "log": ["", "test"],
    "man": [""],
    "mod": [""],
    "mre": [""],
    "nme": ["", "hnrss hackernews"],
    "now": [""],
    "pwd": ["", "bla mekker"],
    "req": [""],
    "res": ["", "hnrss"],
    "srv": [""],
    "tdo": ["", "test2", "test3"],
    "thr": [""],
    "upt": [""]
}


pre = {
    "cfg": ["", "nick=mekker"],
    "imp": ["", "tests/feeds.opml"],
    "log": ["", "bla"],
    "rss": ["","http://hnrss.org/newest"],
    "tdo": ["", "mekker"]
}


post = {
    "dne": ["", "hnrss"],
    "exp": [""],
    "rem": ["", "hnrss"]
}



if __name__ == "__main__":
    main()
